<!doctype html>

<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
<title>Dekha — The Sky Lit Up (final - punchier)</title>
<style>
  :root{
    --bg:#030311;
    --text:#f0f8ff;
    --hint:#c7d6e8;
  }
  html,body{height:100%;margin:0;background:var(--bg);font-family:Inter,system-ui,Arial;color:var(--text);-webkit-font-smoothing:antialiased}
  #app{position:relative;height:100vh;overflow:hidden}
  /* camera feed (not mirrored) */
  video#cam{position:fixed;inset:0;width:100%;height:100%;object-fit:cover;
    filter:brightness(0.44) contrast(1.02) saturate(0.98);z-index:1;transition:filter 900ms ease;}
  canvas#fx{position:fixed;inset:0;width:100%;height:100%;pointer-events:none;mix-blend-mode:screen;z-index:22}
  .bloom{position:fixed;inset:0;z-index:24;pointer-events:none;mix-blend-mode:screen;opacity:0;transition:opacity 900ms ease;}
  .bloom .glow{position:absolute;inset:-20%;background:radial-gradient(circle at 50% 30%, rgba(255,240,210,0.18), rgba(255,200,120,0.08) 18%, rgba(0,0,0,0) 48%);filter:blur(28px);opacity:0;transform:scale(0.92);transition:all 900ms cubic-bezier(.2,.9,.2,1)}
  .bloom.on{opacity:1}
  .bloom.on .glow{opacity:1;transform:scale(1.06)}
  .overlay{position:fixed;inset:0;z-index:26;pointer-events:none}
  .ui{position:fixed;left:50%;transform:translateX(-50%);bottom:22px;text-align:center;z-index:1000;pointer-events:auto;transition:opacity 260ms ease, transform 260ms ease}
  #start{background:linear-gradient(180deg,#f8fbff,#eff7ff);color:#071026;border-radius:999px;padding:12px 18px;font-size:16px;border:none;box-shadow:0 8px 26px rgba(2,6,20,0.45)}
  .hint{font-size:12px;color:var(--hint);margin-top:8px;opacity:0.95}
  .msg{position:fixed;left:50%;transform:translateX(-50%) translateY(10px);bottom:60px;z-index:40;font-size:14px;padding:8px 14px;opacity:0;
    transition:opacity 500ms ease, transform 500ms cubic-bezier(.2,.9,.2,1);color:var(--text);text-align:center;border-radius:12px;backdrop-filter: blur(6px);pointer-events:none}
  .msg.show{opacity:1;transform:translateX(-50%) translateY(0)}
  .hidden { opacity: 0; transform: translateY(10px) scale(.98); pointer-events: none; }
  .sparkle-layer{position:fixed;inset:0;pointer-events:none;z-index:23;mix-blend-mode:screen}
</style>
</head>
<body>
<div id="app">
  <video id="cam" playsinline autoplay muted></video>
  <canvas id="fx"></canvas>  <div class="bloom" id="bloom"><div class="glow"></div></div>  <div class="overlay">
    <div class="msg" id="msg" aria-hidden="true">Dekha, roshni ho gayi har jagah ✨</div>
    <div class="sparkle-layer" id="sparks"></div>
  </div>  <div class="ui" id="ui" role="button" aria-label="Start overlay">
    <button id="start">Tap anywhere to begin</button>
    <div class="hint" id="hint">Open this outdoors at night, point at the sky and tap.</div>
  </div>
</div><audio id="chime"></audio>

<script>
(async function(){
  const video = document.getElementById('cam');
  const canvas = document.getElementById('fx');
  const ctx = canvas.getContext('2d', { alpha: true });
  const startBtn = document.getElementById('start');
  const ui = document.getElementById('ui');
  const hint = document.getElementById('hint');
  const msg = document.getElementById('msg');
  const bloom = document.getElementById('bloom');
  const chime = document.getElementById('chime');
  chime .volume = 0.66;

  let w = canvas.width = innerWidth;
  let h = canvas.height = innerHeight;
  addEventListener('resize', ()=>{ w = canvas.width = innerWidth; h = canvas.height = innerHeight; });

  // camera
  let cameraOK = false;
  try {
    const s = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio:false });
    video.srcObject = s;
    cameraOK = true;
    hint.classList.add('hidden');
  } catch(e){
    console.warn('camera denied', e);
  }

  // particle layers
  let cool = [], warm = [], accent = [];
  let running = false;

  function makeCool(x,y){
    return { x, y, vx:(Math.random()*0.16-0.08), vy:(Math.random()*-0.06-0.015), life:200+Math.random()*320, r:0.6+Math.random()*1.6, tw:Math.random()*6.28, a:0.45+Math.random()*0.45 };
  }
  function makeWarm(x,y){
    return { x, y, vx:(Math.random()*0.12-0.06), vy:(Math.random()*-0.045-0.01), life:140+Math.random()*260, r:1+Math.random()*2.2, tw:Math.random()*6.28, a:0.28+Math.random()*0.48 };
  }
  function makeAccent(x,y){
    return { x, y, vx:(Math.random()*0.18-0.09), vy:(Math.random()*-0.06-0.02), life:80+Math.random()*160, r:0.8+Math.random()*1.6, tw:Math.random()*6.28, a:0.6+Math.random()*0.4 };
  }

  function spawnAtXY(x,y, probCool=0.62, probWarm=0.26){
    const r = Math.random();
    if(r < probCool) cool.push(makeCool(x,y));
    else if(r < probCool + probWarm) warm.push(makeWarm(x,y));
    else accent.push(makeAccent(x,y));
    if(cool.length>1200) cool.splice(0,cool.length-900);
    if(warm.length>900) warm.splice(0,warm.length-700);
    if(accent.length>300) accent.splice(0,accent.length-240);
  }

  function spawnWideLayerAt(x1,x2,y1,y2, qty){
    for(let i=0;i<qty;i++){
      const x = x1 + Math.random()*(x2-x1);
      const y = y1 + Math.random()*(y2-y1);
      spawnAtXY(x,y);
    }
  }

  function initialSoftSprinkle(){
    const topLimit = Math.max(60, h*0.65);
    for(let i=0;i<28;i++){
      const x = 20 + Math.random()*(w-40);
      const y = 8 + Math.random()*topLimit;
      spawnAtXY(x,y);
    }
  }

  // draw: bright core + tight halo for each layer (with colour variance + punch)
  function step(){
    ctx.clearRect(0,0,w,h);
    ctx.fillStyle = 'rgba(0,0,0,0.04)';
    ctx.fillRect(0,0,w,h);

    // cool layer (crisp core + subtle halo) — bluish range with variance
    for(let i=cool.length-1;i>=0;i--){
      const s = cool[i];
      s.tw += 0.007 + Math.random()*0.01;
      s.x += s.vx + Math.sin(s.tw)*0.06;
      s.y += s.vy + Math.cos(s.tw)*0.02;
      s.life--;
      const t = 0.5 + 0.5*Math.sin(s.tw*1.7);
      const lf = Math.max(0, Math.min(1, s.life/420));
      const alpha = Math.min(1, s.a * (0.6 + 0.6*t) * lf);

      // hue variance for magic
      const hueShift = 200 + Math.random()*70; // ~200–270 (cyan→pale blue)
      const coreColor = `hsla(${hueShift}, 100%, 88%, ${Math.min(1, 3 * alpha)})`;
      ctx.globalCompositeOperation = 'lighter';
      ctx.fillStyle = coreColor;
      ctx.beginPath();
      ctx.arc(s.x, s.y, Math.max(0.9, s.r * 1.4), 0, Math.PI*2);
      ctx.fill();

      // tight halo
      const haloColor = `hsla(${hueShift}, 100%, 75%, ${0.10 * lf})`;
      const glow = 3 + s.r * 2;
      const g = ctx.createRadialGradient(s.x,s.y,0,s.x,s.y,glow);
      g.addColorStop(0.12, coreColor);
      g.addColorStop(0.28, haloColor);
      g.addColorStop(1, 'rgba(0,0,0,0)');
      ctx.fillStyle = g;
      ctx.beginPath(); ctx.arc(s.x,s.y, Math.max(1.2, s.r * 3.0), 0, Math.PI*2); ctx.fill();

      // subtle outline
      ctx.strokeStyle = `rgba(245,250,255,${0.18 * alpha})`;
      ctx.lineWidth = 0.45;
      ctx.stroke();

      ctx.globalCompositeOperation = 'source-over';
      if(s.life<=0 || s.x<-80 || s.x>w+80 || s.y<-120) cool.splice(i,1);
    }

    // warm layer (golden cores with smaller halo) — warm range with variance
    for(let i=warm.length-1;i>=0;i--){
      const wv = warm[i];
      wv.tw += 0.005 + Math.random()*0.009;
      wv.x += wv.vx + Math.sin(wv.tw)*0.04;
      wv.y += wv.vy + Math.cos(wv.tw)*0.015;
      wv.life--;
      const t = 0.5 + 0.5*Math.sin(wv.tw*1.5);
      const lf = Math.max(0, Math.min(1, wv.life/360));
      const alpha = Math.min(1, wv.a * (0.5 + 0.7*t) * lf);

      const hueShift = 25 + Math.random()*30; // 25–55 (warm gold/orange)
      const coreColor = `hsla(${hueShift}, 100%, 82%, ${Math.min(1, 1.25 * alpha)})`;
      ctx.globalCompositeOperation = 'lighter';
      ctx.fillStyle = coreColor;
      ctx.beginPath();
      ctx.arc(wv.x, wv.y, Math.max(1.0, wv.r * 1.6), 0, Math.PI*2);
      ctx.fill();

      const haloColor = `hsla(${hueShift}, 100%, 70%, ${0.08 * lf})`;
      const glow = 4 + wv.r * 3;
      const g2 = ctx.createRadialGradient(wv.x,wv.y,0,wv.x,wv.y,glow);
      g2.addColorStop(0.12, coreColor);
      g2.addColorStop(0.30, haloColor);
      g2.addColorStop(1, 'rgba(0,0,0,0)');
      ctx.fillStyle = g2;
      ctx.beginPath(); ctx.arc(wv.x,wv.y, Math.max(1.6, wv.r * 3.6),0,Math.PI*2); ctx.fill();

      ctx.strokeStyle = `rgba(255,245,210,${0.14*alpha})`;
      ctx.lineWidth = 0.45;
      ctx.stroke();

      ctx.globalCompositeOperation = 'source-over';
      if(wv.life<=0 || wv.x<-120 || wv.x>w+120 || wv.y<-160) warm.splice(i,1);
    }

    // accent lavenders (crisp, violet-ish variance)
    for(let i=accent.length-1;i>=0;i--){
      const a = accent[i];
      a.tw += 0.01 + Math.random()*0.02;
      a.x += a.vx + Math.sin(a.tw)*0.06;
      a.y += a.vy + Math.cos(a.tw)*0.03;
      a.life--;
      const t = 0.5 + 0.5*Math.sin(a.tw*2.8);
      const lf = Math.max(0, Math.min(1, a.life / 220));
      const alpha = Math.min(1, a.a * (0.6 + 0.8*t) * lf);

      const hueShift = 260 + Math.random()*60; // 260–320 (violet → magenta)
      const coreColor = `hsla(${hueShift}, 100%, 86%, ${Math.min(1, 1.25 * alpha)})`;
      ctx.globalCompositeOperation = 'lighter';
      ctx.fillStyle = coreColor;
      ctx.beginPath();
      ctx.arc(a.x, a.y, Math.max(0.9, a.r * 1.4), 0, Math.PI*2);
      ctx.fill();

      const haloColor = `hsla(${hueShift}, 100%, 75%, ${0.08 * lf})`;
      const glow = 3 + a.r * 3;
      const g3 = ctx.createRadialGradient(a.x,a.y,0,a.x,a.y,glow);
      g3.addColorStop(0.12, coreColor);
      g3.addColorStop(0.28, haloColor);
      g3.addColorStop(1, 'rgba(0,0,0,0)');
      ctx.fillStyle = g3;
      ctx.beginPath(); ctx.arc(a.x,a.y, Math.max(1.0, a.r * 3.0), 0, Math.PI*2); ctx.fill();

      ctx.strokeStyle = `rgba(240,190,255,${0.14 * alpha})`;
      ctx.lineWidth = 0.4;
      ctx.stroke();

      ctx.globalCompositeOperation = 'source-over';
      if(a.life<=0 || a.x<-80 || a.x>w+80 || a.y<-120) accent.splice(i,1);
    }

    requestAnimationFrame(step);
  }
  step();

  // orientation target
  let orientTarget = null, lastOrient = { x:w/2, y:h*0.32 };
  function setTargetFromOrientation(a,b,g){
    const nx = (0.5 + (g||0)/90 * 0.5) * w;
    const ny = (0.2 + (b||0)/180 * 0.55) * h;
    orientTarget = { x:nx, y:ny };
  }
  if(window.DeviceOrientationEvent){
    window.addEventListener('deviceorientation', (ev)=>{ setTargetFromOrientation(ev.alpha, ev.beta||0, ev.gamma||0); }, true);
  }

  // ramp logic
  let startTime = null;
  const rampDuration = 8000;

  function rampFactor(now){
    if(!startTime) return 0;
    return Math.min(1, Math.max(0, (now - startTime) / rampDuration));
  }

  let spawnerHandle = null;
  function startSpawner(){
    if(spawnerHandle) clearInterval(spawnerHandle);
    spawnerHandle = setInterval(()=>{
      const now = performance.now();
      const rf = rampFactor(now);
      // increased base by ~30%
      const base = Math.round(8 * (0.25 + 0.75 * rf) * 1.30);

      if(orientTarget && Math.random() < 0.6){
        const sx = lastOrient.x + (Math.random()*180-90);
        const sy = lastOrient.y + (Math.random()*90-45);
        spawnWideLayerAt(Math.max(20, sx-120), Math.min(w-20, sx+120), Math.max(20, sy-80), Math.min(h-40, sy+80), Math.max(4, Math.round(base/2)));
      } else {
        const topY = Math.max(60, h * 0.72);
        spawnWideLayerAt(20, w-20, 20, topY, Math.max(6, base));
      }
      if(Math.random() < 0.12 * (0.4 + 0.6*rf) * 1.15) {
        spawnWideLayerAt(40, w-40, 20, Math.max(120, h*0.6), Math.round(6 * (0.4 + 0.6*rf) * 1.25));
      }
    }, 320); // faster cadence (was 420)
  }

  function gentleIntro(){
    initialSoftSprinkle();
  }

  function begin(){
    if(running) return;
    running = true;
    startTime = performance.now();
    ui.classList.add('hidden');
    hint.classList.add('hidden');

    bloom.classList.add('on');
    // moderate brighten
    video.style.filter = 'brightness(1.06) contrast(1.04) saturate(1.04)';
    try{ chime.currentTime = 0; chime.play().catch(()=>{}); }catch(e){}
    gentleIntro();
    startSpawner();

    // show message at 6 seconds
    setTimeout(()=>{ 
      msg.classList.add('show'); 
      msg.setAttribute('aria-hidden','false'); 
    }, 6000);

    // after ramp + buffer, reduce to ambient spawner but keep ~30% more
    setTimeout(()=>{ 
      if(spawnerHandle){ 
        clearInterval(spawnerHandle); 
        spawnerHandle = setInterval(()=>{ spawnWideLayerAt(20, w-20, 20, Math.max(80, h*0.7), Math.round(18 * 1.3)); }, 1200); 
      } 
    }, rampDuration + 9000);
  }

  startBtn.addEventListener('click', begin, {passive:true});
  canvas.addEventListener('touchstart', begin, {passive:true});
  document.body.addEventListener('touchstart', begin, {passive:true});
  document.body.addEventListener('click', begin, {passive:true});

  if(!cameraOK) hint.classList.remove('hidden');

})();
</script></body>
</html>
